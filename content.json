{"posts":[{"title":"Modular Multiplication Designs","text":"In cryptography, modular multiplication is a fundamental arithmetic unit in calculation. Usually the cryptographic objects are based on data structures over finite fields. Thus, modular arithmetic operations are the atoms of cryptography. Modular addition/substraction is straightforward, but modular multiplication is a bit complicated. Though many literatures have discussed how to evaluate the modular multiplication with plain multiplication for general moduli, for faster modular multiplication, the number-theoretic properties of special moduli like NTT-friendly or low hamming-weight should be further utilized. In this blog, I will introduce some tricks on modular multiplication designs. A Tighter Parameter-selection Method for Barrett ModMulFor \\(2^{n-1}&lt;q&lt;2^n\\), a Barrett modmul can be written as $$z=xy\\mod{q}=xy-\\left\\lfloor\\frac{\\left\\lfloor\\frac{xy}{2^{n+\\alpha}}\\right\\rfloor\\cdot\\left\\lfloor\\frac{2^{2n+\\alpha+\\beta}}{q}\\right\\rfloor}{2^{n+\\beta}}\\right\\rfloor\\cdot q$$ , where its key trick is to estimate the quotient \\(\\left\\lfloor\\frac{xy}{q}\\right\\rfloor\\) with \\(\\left\\lfloor\\frac{\\left\\lfloor\\frac{xy}{2^{n+\\alpha}}\\right\\rfloor\\cdot\\left\\lfloor\\frac{2^{2n+\\alpha+\\beta}}{q}\\right\\rfloor}{2^{n+\\beta}}\\right\\rfloor\\) and \\(\\alpha,\\beta\\) are variable parameters for better estimation. The Classic EstimationAssume \\(0\\leq x,y&lt;2q\\) and we want to ensure that the result \\(z\\) locates in the same region. A classic estimation would be $$\\begin{align*}\\frac{\\left\\lfloor\\frac{xy}{2^{n+\\alpha}}\\right\\rfloor\\cdot\\left\\lfloor\\frac{2^{2n+\\alpha+\\beta}}{q}\\right\\rfloor}{2^{n+\\beta}}\\leq&amp;\\frac{xy}{q}\\\\\\frac{\\left\\lfloor\\frac{xy}{2^{n+\\alpha}}\\right\\rfloor\\cdot\\left\\lfloor\\frac{2^{2n+\\alpha+\\beta}}{q}\\right\\rfloor}{2^{n+\\beta}}&gt;&amp;\\frac{\\left(\\frac{xy}{2^{n+\\alpha}}-1\\right)\\cdot\\left(\\frac{2^{2n+\\alpha+\\beta}}{q}-1\\right)}{2^{n+\\beta}}\\\\=&amp;\\frac{xy}{q}-\\frac{2^{n+\\alpha}}{q}-\\frac{xy}{2^{2n+\\alpha+\\beta}}+\\frac{1}{2^{n+\\beta}}\\\\\\geq&amp;\\left\\lfloor\\frac{xy}{q}\\right\\rfloor-\\frac{1}{2}-\\frac{1}{2}+0=\\left\\lfloor\\frac{xy}{q}\\right\\rfloor-1\\end{align*}$$ Therefore, as long as \\(\\frac{2^{n+\\alpha}}{q}\\leq\\frac{1}{2},\\frac{xy}{2^{2n+\\alpha+\\beta}}\\leq\\frac{1}{2}\\), we have $$\\left\\lfloor\\frac{xy}{q}\\right\\rfloor\\geq\\left\\lfloor\\frac{\\left\\lfloor\\frac{xy}{2^{n+\\alpha}}\\right\\rfloor\\cdot\\left\\lfloor\\frac{2^{2n+\\alpha+\\beta}}{q}\\right\\rfloor}{2^{n+\\beta}}\\right\\rfloor\\geq\\left\\lfloor\\frac{xy}{q}\\right\\rfloor-1$$and a step further,$$z=xy-\\left\\lfloor\\frac{\\left\\lfloor\\frac{xy}{2^{n+\\alpha}}\\right\\rfloor\\cdot\\left\\lfloor\\frac{2^{2n+\\alpha+\\beta}}{q}\\right\\rfloor}{2^{n+\\beta}}\\right\\rfloor\\cdot q\\leq xy-(\\left\\lfloor\\frac{xy}{q}\\right\\rfloor-1)\\cdot q=(xy\\mod{q})+q&lt;2q$$ The parameter selection is then quite straightforward, take \\(\\alpha\\leq-2,\\alpha+\\beta\\geq3\\). A Tighter EstimationThe classic estimation simply applies the relation \\(x-1&lt;\\lfloor x\\rfloor\\leq x\\). We can estimate the quotient with another equivalence rather than the inequality set, which is$$\\left\\lfloor\\frac{x}{m}\\right\\rfloor=\\frac{x-[x]_m}{m}$$where \\([x]_m=x\\mod{m}\\in[0,m-1]\\). Therefore, the approximated quotient can be re-written as$$\\begin{align*}\\left\\lfloor\\frac{\\left\\lfloor\\frac{xy}{2^{n+\\alpha}}\\right\\rfloor\\cdot\\left\\lfloor\\frac{2^{2n+\\alpha+\\beta}}{q}\\right\\rfloor}{2^{n+\\beta}}\\right\\rfloor=&amp;\\left\\lfloor\\frac{\\frac{xy-[xy]_{2^{n+\\alpha}}}{2^{n+\\alpha}}\\cdot\\frac{2^{2n+\\alpha+\\beta}-[2^{2n+\\alpha+\\beta}]_q}{q}}{2^{n+\\beta}}\\right\\rfloor\\\\=&amp;\\left\\lfloor\\frac{xy}{q}-\\frac{xy[2^{2n+\\alpha+\\beta}]_q}{2^{2n+\\alpha+\\beta}q}-\\frac{[xy]_{2^{n+\\beta}}\\cdot(2^{2n+\\alpha+\\beta}-[2^{2n+\\alpha+\\beta}]_q)}{2^{2n+\\alpha+\\beta}q}\\right\\rfloor\\\\=&amp;\\left\\lfloor\\frac{xy}{q}\\right\\rfloor+\\left\\lfloor\\frac{[xy]_q}{q}-\\frac{xy[2^{2n+\\alpha+\\beta}]_q}{2^{2n+\\alpha+\\beta}q}-\\frac{[xy]_{2^{n+\\beta}}\\cdot(2^{2n+\\alpha+\\beta}-[2^{2n+\\alpha+\\beta}]_q)}{2^{2n+\\alpha+\\beta}q}\\right\\rfloor\\\\=&amp;\\left\\lfloor\\frac{xy}{q}\\right\\rfloor+\\left\\lfloor\\frac{[xy]_q2^{2n+\\alpha+\\beta}-xy[2^{2n+\\alpha+\\beta}]_q-[xy]_{2^{n+\\beta}}\\cdot(2^{2n+\\alpha+\\beta}-[2^{2n+\\alpha+\\beta}]_q)}{2^{2n+\\alpha+\\beta}q}\\right\\rfloor\\end{align*}$$ Therefore, one need only to satisfy the constraint$$C(\\alpha,\\beta)=\\min_{x,y}{\\frac{[xy]_q2^{2n+\\alpha+\\beta}-xy[2^{2n+\\alpha+\\beta}]_q-[xy]_{2^{n+\\beta}}\\cdot(2^{2n+\\alpha+\\beta}-[2^{2n+\\alpha+\\beta}]_q)}{2^{2n+\\alpha+\\beta}q}}\\geq -1$$","link":"/2025/04/09/modmul%20designs/"},{"title":"Zhen Gu","text":"","link":"/2025/04/01/zhengu/"}],"tags":[{"name":"arithmetic","slug":"arithmetic","link":"/tags/arithmetic/"},{"name":"crypto","slug":"crypto","link":"/tags/crypto/"},{"name":"hardware","slug":"hardware","link":"/tags/hardware/"}],"categories":[{"name":"tech blogs","slug":"tech-blogs","link":"/categories/tech-blogs/"},{"name":"home","slug":"home","link":"/categories/home/"}],"pages":[]}